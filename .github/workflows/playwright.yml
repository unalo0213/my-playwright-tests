name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: {} # 這樣你之後可以在網頁手動點按鈕執行

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    env:
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/pw-browsers

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
         
      # 1. 獨立處理 npm 快取，並給它一個 id: npm-cache
      - name: Cache node modules
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: playwright/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('playwright/package-lock.json') }}

      # 2. 如果快取命中 (cache-hit == 'true')，就跳過這整步
      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci
        working-directory: ./playwright

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npm list @playwright/test --depth=0 | grep @playwright/test | sed 's/.*@//')" >> $GITHUB_OUTPUT
        working-directory: ./playwright

      - name: Cache Playwright Browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

      # 拆分：系統依賴一定要裝，但瀏覽器只有在 cache-hit != 'true' 才裝
      - name: Install Playwright System Dependencies
        run: npx playwright install-deps
        working-directory: ./playwright    

      - name: Install Playwright Browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true' # 如果快取存在就跳過
        run: npx playwright install --with-deps
        working-directory: ./playwright

      - name: Run Playwright tests
        run: npx playwright test
        working-directory: ./playwright

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ./playwright/playwright-report/
          retention-days: 3

      - name: Deploy to GitHub Pages
        if: always() # 確保測試失敗也能看報告
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright/playwright-report
